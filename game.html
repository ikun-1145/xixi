<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>小游戏</title>

<link rel="preload" as="image" href="p/chengshi.webp" type="image/webp">
<link rel="preload" as="image" href="p/chengshi.png">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",
  "Microsoft YaHei",Arial,sans-serif;
  background:url("p/chengshi.png") center/cover no-repeat #87CEEB;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  min-height: 100svh;
}
@supports (background-image: url("p/chengshi.webp")) {
  body {
    background:url("p/chengshi.webp") center/cover no-repeat #87CEEB;
  }
}

#gameWrapper{
  position:relative;
  margin:2vh auto;
  display:flex;
  justify-content:center;
}
canvas{
  border-radius:12px;
  box-shadow:0 10px 20px rgba(0,0,0,.25);
  touch-action: none;
}

.overlay{
  position:absolute;
  inset:0;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:16px;
  background:rgba(0,0,0,.35);
  border-radius:12px;
}

.overlay h1{
  color:#fff;
  font-size:48px;
  text-shadow:2px 2px 0 #000;
}

.overlay button{
  padding:.8rem 2.2rem;
  font-size:1.2rem;
  font-weight:700;
  border-radius:30px;
  border:2px solid #fff;
  background:linear-gradient(#71f8fc,#40e0d0);
  color:#004d4d;
  cursor:pointer;
  transition:transform 0.1s;
}

.overlay button:hover{
  transform:scale(1.05);
}

.overlay button:active{
  transform:scale(0.95);
}

.loading {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(135, 206, 235, 0.95);
  font-size: 24px;
  color: white;
  z-index: 1000;
  gap: 20px;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.overlay button{
  margin-top: 12px;
}

@media (orientation: landscape) and (max-width: 900px) {
  #gameWrapper{
    align-items: center;
  }

  .overlay{
    flex-direction: row;
    justify-content: center;
    gap: 24px;
  }

  .overlay h1{
    font-size: 36px;
  }

  .overlay button{
    font-size: 1.1rem;
    padding: .7rem 1.8rem;
  }
}

@supports (padding: env(safe-area-inset-bottom)) {
  body{
    padding-bottom: env(safe-area-inset-bottom);
  }

  .overlay{
    padding-bottom: env(safe-area-inset-bottom);
  }
}
</style>
</head>

<body>
<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <div>加载中...</div>
</div>

<div id="gameWrapper">
  <canvas id="game" role="img" aria-label="游戏画面"></canvas>

  <div class="overlay" id="overlay" role="dialog" aria-labelledby="overText">
    <h1 id="overText">游戏结束</h1>
    <button id="restart" autofocus>再来一局</button>
  </div>
</div>

<script>
const i18n = {
  zh: {
    title: "小游戏",
    gameOver: "游戏结束",
    restart: "再来一局",
    loading: "加载中...",
    tapToStart: "点击屏幕开始",
    highScore: "最高"
  },
  en: {
    title: "Mini Game",
    gameOver: "Game Over",
    restart: "Play Again",
    loading: "Loading...",
    tapToStart: "Tap to Start",
    highScore: "Best"
  },
  ja: {
    title: "ミニゲーム",
    gameOver: "ゲームオーバー",
    restart: "もう一度",
    loading: "読み込み中...",
    tapToStart: "タップして開始",
    highScore: "最高"
  }
};

function detectLang(){
  const saved = localStorage.getItem("lang");
  if (saved && i18n[saved]) return saved;
  const nav = navigator.language || "zh";
  if (nav.startsWith("ja")) return "ja";
  if (nav.startsWith("en")) return "en";
  return "zh";
}

const LANG = detectLang();
const T = i18n[LANG] || i18n.zh;

const CONFIG = {
  LOGIC_W: 400,
  LOGIC_H: 650,
  GRAVITY: 0.30,
  JUMP_FORCE: -5.2,
  PIPE_GAP: 170,
  PIPE_WIDTH: 65,
  PIPE_SPACING: 240,
  PIPE_SPEED: 2.8,
  MAX_FALL_SPEED: 12,
  BIRD_SIZE: 34,
  BIRD_START_X: 60,
  BIRD_START_Y: 300,
  COLLISION_PADDING: 4,
  GROUND_OFFSET: 10,
  MAX_SCALE: 2.0
};

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const restartBtn = document.getElementById("restart");
const loadingEl = document.getElementById("loading");

let scale = 1;
let transformSet = false;

function resize(){
  const dpr = window.devicePixelRatio || 1;
  const availableW = window.innerWidth;
  const availableH = window.innerHeight * 0.95;
  let widthBased = availableW / CONFIG.LOGIC_W;
  let heightBased = availableH / CONFIG.LOGIC_H;
  scale = Math.max(widthBased, heightBased);
  scale = Math.min(scale, CONFIG.MAX_SCALE);
  canvas.style.width = CONFIG.LOGIC_W * scale + "px";
  canvas.style.height = CONFIG.LOGIC_H * scale + "px";
  canvas.width = Math.round(CONFIG.LOGIC_W * scale * dpr);
  canvas.height = Math.round(CONFIG.LOGIC_H * scale * dpr);
  transformSet = false;
  if(gameState !== 'loading') {
    draw();
  }
}

window.addEventListener("resize", resize);
resize();

const birdImg = new Image();
let assetsLoaded = false;

function loadAssets(){
  return new Promise((resolve) => {
    let completed = false;
    const finish = () => {
      if(completed) return;
      completed = true;
      resolve();
    };
    birdImg.onload = () => {
      console.log('鸟图片加载成功');
      assetsLoaded = true;
      finish();
    };
    birdImg.onerror = () => {
      console.warn('鸟图片加载失败，使用降级样式');
      assetsLoaded = false;
      finish();
    };
    birdImg.src = "p/bird.png";
    setTimeout(() => {
      if(!completed) {
        console.warn('图片加载超时，使用降级样式');
        assetsLoaded = false;
        finish();
      }
    }, 1000);
  });
}

let gameState = 'loading';
let player, pipes, score, highScore, rafId;
highScore = Number(localStorage.getItem("highScore")) || 0;

function resetGame(){
  player = {
    x: CONFIG.BIRD_START_X,
    y: CONFIG.BIRD_START_Y,
    size: CONFIG.BIRD_SIZE,
    dy: 0,
    angle: 0
  };
  pipes = [];
  score = 0;
  gameState = 'ready';
  overlay.style.display = "none";
  for(let i = 0; i < 2; i++){
    createPipe(CONFIG.LOGIC_W + 100 + i * CONFIG.PIPE_SPACING);
  }
  cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}

function createPipe(x){
  const min = 50;
  const max = CONFIG.LOGIC_H - CONFIG.PIPE_GAP - 120;
  const top = Math.random() * (max - min) + min;
  pipes.push({ x, top, passed: false });
}

function hit(a, b){
  const pad = CONFIG.COLLISION_PADDING;
  return !(
    a.x + a.w - pad < b.x ||
    a.x + pad > b.x + b.w ||
    a.y + a.h - pad < b.y ||
    a.y + pad > b.y + b.h
  );
}

function update(){
  if(gameState !== 'playing') return;
  player.dy += CONFIG.GRAVITY;
  if(player.dy > CONFIG.MAX_FALL_SPEED) player.dy = CONFIG.MAX_FALL_SPEED;
  player.y += player.dy;
  if(pipes[pipes.length - 1].x < CONFIG.LOGIC_W - CONFIG.PIPE_SPACING){
    createPipe(CONFIG.LOGIC_W + 50);
  }
  pipes.forEach(p => p.x -= CONFIG.PIPE_SPEED);
  pipes = pipes.filter(p => p.x + CONFIG.PIPE_WIDTH > -100);
  const birdBox = {
    x: player.x,
    y: player.y,
    w: player.size,
    h: player.size
  };
  for(const p of pipes){
    const topBox = {
      x: p.x,
      y: 0,
      w: CONFIG.PIPE_WIDTH,
      h: p.top
    };
    const botBox = {
      x: p.x,
      y: p.top + CONFIG.PIPE_GAP,
      w: CONFIG.PIPE_WIDTH,
      h: CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    };
    if(hit(birdBox, topBox) || hit(birdBox, botBox)){
      endGame();
      return;
    }
    if(!p.passed && player.x + player.size / 2 > p.x + CONFIG.PIPE_WIDTH / 2){
      score++;
      p.passed = true;
    }
  }
  if(player.y + player.size > CONFIG.LOGIC_H - CONFIG.GROUND_OFFSET || player.y < -player.size){
    endGame();
    return;
  }
  player.angle = Math.max(-0.35, Math.min(Math.PI / 2, player.dy * 0.12));
}

function draw(){
  const dpr = window.devicePixelRatio || 1;
  if(!transformSet){
    ctx.setTransform(scale * dpr, 0, 0, scale * dpr, 0, 0);
    transformSet = true;
  }
  ctx.clearRect(0, 0, CONFIG.LOGIC_W, CONFIG.LOGIC_H);
  ctx.fillStyle = "#5cb85c";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, CONFIG.PIPE_WIDTH, p.top);
    ctx.fillRect(
      p.x,
      p.top + CONFIG.PIPE_GAP,
      CONFIG.PIPE_WIDTH,
      CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    );
  });
  ctx.save();
  ctx.translate(player.x + player.size / 2, player.y + player.size / 2);
  ctx.rotate(player.angle);
  if(assetsLoaded && birdImg.complete){
    ctx.drawImage(birdImg, -player.size / 2, -player.size / 2, player.size, player.size);
  } else {
    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
  }
  ctx.restore();
  ctx.fillStyle = "#fff";
  ctx.font = "900 42px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(score, CONFIG.LOGIC_W / 2, 60);
  ctx.font = "600 20px sans-serif";
  ctx.fillText(T.highScore + ": " + highScore, CONFIG.LOGIC_W / 2, 110);
  if(gameState === 'ready'){
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(0, CONFIG.LOGIC_H / 2 - 50, CONFIG.LOGIC_W, 100);
    ctx.fillStyle = "#fff";
    ctx.font = "bold 24px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(T.tapToStart, CONFIG.LOGIC_W / 2, CONFIG.LOGIC_H / 2);
  }
}

function loop(){
  update();
  draw();
  if(gameState !== 'gameOver') {
    rafId = requestAnimationFrame(loop);
  }
}

function endGame(){
  if(gameState === 'gameOver') return;
  gameState = 'gameOver';
  if(score > highScore){
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }
  overlay.style.display = "flex";
}

function jump(e){
  if(e?.code === "Space") e.preventDefault();
  if(gameState === 'ready'){
    gameState = 'playing';
  }
  if(gameState === 'playing'){
    player.dy = CONFIG.JUMP_FORCE;
  }
}

document.addEventListener("keydown", jump);
document.addEventListener("mousedown", jump);
document.addEventListener("touchstart", jump, { passive: false });

restartBtn.onclick = e => {
  e.stopPropagation();
  resetGame();
};

if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
  document.body.addEventListener("touchmove", e => {
    if (e.target === canvas) e.preventDefault();
  }, { passive: false });
  window.addEventListener("orientationchange", () => {
    setTimeout(resize, 300);
  });
}

async function init(){
  try {
    document.title = T.title;
    document.getElementById("overText").textContent = T.gameOver;
    document.getElementById("restart").textContent = T.restart;
    loadingEl.querySelector('div:last-child').textContent = T.loading;
    console.log('开始加载资源...');
    await loadAssets();
    console.log('资源加载完成，启动游戏');
    loadingEl.style.display = 'none';
    resetGame();
  } catch(err) {
    console.error('初始化错误:', err);
    loadingEl.style.display = 'none';
    resetGame();
  }
}

init();
</script>
</body>
</html>