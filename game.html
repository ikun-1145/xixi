<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const buttonsContainer = document.getElementById('buttonsContainer');

// 自动适配屏幕
function resizeCanvas(){
  canvas.width = window.innerWidth * 0.9; // 屏幕宽度90%
  canvas.height = window.innerHeight * 0.7; // 屏幕高度70%
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const playerImg = new Image();
playerImg.src = 'p/player.png';
let playerImgLoaded = false;
playerImg.onload = () => { playerImgLoaded = true; };

let player = { x: 50, y: canvas.height/2, size: 40, dy: 0 };
let gravity = 0.42;
let jump = -8;
let pipes = [];
let pipeWidth = 60;
let pipeGap = 180;
let pipeSpacing = 250;
let score = 0;
let gameOver = false;
let animationId;

function resetGame(){
  resizeCanvas();
  player.y = canvas.height/2;
  player.dy = 0;
  pipes = [];
  score = 0;
  gameOver = false;
  buttonsContainer.style.display = 'none';
  cancelAnimationFrame(animationId);
  if(playerImgLoaded) animate();
  else playerImg.onload = () => { animate(); };
}

function createPipe(){
  let topHeight = Math.floor(Math.random() * (canvas.height - pipeGap - 50)) + 25;
  pipes.push({ x: canvas.width, topHeight, passed: false });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#71f8fc';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = '#2b7a78';
  for(let pipe of pipes){
    ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight);
    ctx.fillRect(pipe.x, pipe.topHeight + pipeGap, pipeWidth, canvas.height - (pipe.topHeight + pipeGap));
  }

  if(playerImgLoaded){
    ctx.drawImage(playerImg, player.x, player.y, player.size, player.size);
  } else {
    ctx.fillStyle = '#ffcc00';
    ctx.fillRect(player.x, player.y, player.size, player.size);
  }

  ctx.fillStyle = '#1A1A1A';
  ctx.font = `${Math.floor(canvas.width/20)}px Product Sans`;
  ctx.fillText(`分数: ${score}`, 10, 30);

  if(gameOver){
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = '#ffffff';
    ctx.font = `${Math.floor(canvas.width/10)}px Product Sans`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('游戏结束', canvas.width/2, canvas.height/2);
  }
}

function update(){
  if(gameOver) return;

  player.dy += gravity;
  player.y += player.dy;

  if(pipes.length === 0 || pipes[pipes.length-1].x < canvas.width - pipeSpacing){
    createPipe();
  }

  for(let pipe of pipes) pipe.x -= 2;
  pipes = pipes.filter(pipe => pipe.x + pipeWidth > 0);

  for(let pipe of pipes){
    if(player.x + player.size > pipe.x && player.x < pipe.x + pipeWidth){
      if(player.y < pipe.topHeight || player.y + player.size > pipe.topHeight + pipeGap){
        endGame();
      }
    }
    if(!pipe.passed && player.x > pipe.x + pipeWidth){
      score++;
      pipe.passed = true;
    }
  }

  if(player.y + player.size > canvas.height || player.y < 0) endGame();
}

function animate(){
  update();
  draw();
  if(!gameOver) animationId = requestAnimationFrame(animate);
}

function endGame(){
  gameOver = true;
  buttonsContainer.style.display = 'flex';
  draw();
}

document.addEventListener('keydown', e => { if(e.code==='Space'&&!gameOver) player.dy=jump; });
document.addEventListener('click', () => { if(!gameOver) player.dy=jump; });
document.getElementById('restartBtn').addEventListener('click', resetGame);

resetGame();
</script>