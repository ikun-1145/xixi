<!DOCTYPE html>

<html lang="zh-Hans">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>小游戏</title>

<link rel="preload" as="image" href="p/chengshi.webp" type="image/webp">
<link rel="preload" as="image" href="p/chengshi.png">
<link rel="preload" as="image" href="p/bird.png">

<style>
/* ================= CSS 变量（主页同款）================= */
:root {
  --bg-main: linear-gradient(135deg, #dcefff, #f8fdff), url('p/chengshi.png') center / cover no-repeat;
  --card-bg: rgba(255,255,255,0.5);
  --text-main: #1A1A1A;
  --accent: #71f8fc;
}

body.night {
  --bg-main: #161823;
  --card-bg: rgba(22,24,35,0.95);
  --text-main: #E8FFFF;
  --accent: #3EEDE7;
}

/* ================= 基础样式 ================= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body.preload {
  opacity: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
               "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC",
               "Source Han Sans SC", Arial, sans-serif;
  background: var(--bg-main);
  min-height: 100vh;
  min-height: 100svh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  color: var(--text-main);
  transition: opacity 0.8s ease;
  overflow: hidden;
}

@supports (background-image: url("p/chengshi.webp")) {
  :root {
    --bg-main: linear-gradient(135deg, #dcefff, #f8fdff), url('p/chengshi.webp') center / cover no-repeat;
  }
}

/* 主页同款粒子动画背景 */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.45) 0, rgba(255,255,255,0) 60%),
    radial-gradient(circle at 80% 70%, rgba(255,255,255,0.38) 0, rgba(255,255,255,0) 60%),
    radial-gradient(circle at 40% 80%, rgba(255,255,255,0.42) 0, rgba(255,255,255,0) 60%);
  background-size: 120% 120%;
  animation: floatParticles 18s ease-in-out infinite alternate;
  pointer-events: none;
  z-index: -1;
}

body.night::before {
  background:
    radial-gradient(circle at 30% 30%, rgba(62,237,231,0.12), transparent 60%),
    radial-gradient(circle at 70% 70%, rgba(62,237,231,0.08), transparent 60%);
}

@keyframes floatParticles {
  0% { background-position: 0% 0%; }
  100% { background-position: 100% 100%; }
}

/* ================= 游戏容器 ================= */
#gameWrapper {
  position: relative;
  margin: 2dvh auto;
  width: min(96vw, calc(100dvh * 0.95 * 0.62));
  max-width: min(96vw, 52rem);
  aspect-ratio: 400 / 650;
  display: flex;
  justify-content: center;
  align-items: center;
  animation: fadeInUp 1s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

canvas {
  width: 100%;
  height: 100%;
  max-width: 100%;
  max-height: 100%;
  display: block;
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(80, 140, 200, 0.25), 
              inset 0 0 40px rgba(200, 240, 255, 0.4), 
              0 10px 30px rgba(0,0,0,0.08);
  touch-action: none;
  animation: float 6s ease-in-out infinite;
}

@media (min-width: 1024px) {
  #gameWrapper {
    width: min(88vw, calc(100dvh * 0.92 * 0.615));
    max-width: 58rem;
  }
}

@media (min-width: 768px) and (max-width: 1023.98px) {
  #gameWrapper {
    width: min(92vw, calc(100dvh * 0.92 * 0.615));
    max-width: 46rem;
  }

  .overlay h1 {
    font-size: clamp(2rem, 4vw, 2.6rem);
  }

  .overlay button {
    font-size: clamp(1rem, 2vw, 1.2rem);
  }
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
  100% { transform: translateY(0); }
}

/* ================= 游戏结束遮罩（主页同款毛玻璃）================= */
.overlay {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 20px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 16px;
}

/* 兼容性兜底 */
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))) {
  .overlay {
    background: rgba(255,255,255,0.9);
  }
  body.night .overlay {
    background: rgba(22,24,35,0.95);
  }
}

.overlay h1 {
  color: var(--text-main);
  font-size: 48px;
  text-shadow: 0 0 20px rgba(113, 248, 252, 0.3);
  animation: modalPop 0.5s ease;
}

@keyframes modalPop {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* ================= 按钮样式（主页同款）================= */
.overlay button {
  padding: 0.8rem 2.2rem;
  font-size: 1.2rem;
  font-weight: 700;
  border-radius: 30px;
  border: none;
  background: var(--accent);
  color: #000;
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
  animation: breatheGlow 3s ease-in-out infinite;
  box-shadow: 0 0 12px rgba(113, 248, 252, 0.35);
}

@keyframes breatheGlow {
  0% { box-shadow: 0 0 12px rgba(113, 248, 252, 0.35); }
  50% { box-shadow: 0 0 22px rgba(113, 248, 252, 0.55); }
  100% { box-shadow: 0 0 12px rgba(113, 248, 252, 0.35); }
}

.overlay button:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(80, 160, 255, 0.35);
  filter: brightness(1.08);
}

.overlay button:active {
  transform: translateY(-1px);
}

/* ================= 加载动画（主页同款）================= */
#loading {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  transition: opacity 0.6s ease;
  background: radial-gradient(
    circle at center,
    rgba(113,248,252,0.18),
    #ffffff 65%
  );
}

body.night #loading {
  background: radial-gradient(
    circle at center,
    rgba(62,237,231,0.14),
    rgba(22,24,35,0.96) 65%
  );
}

.loader {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: 6px solid rgba(0,0,0,0.08);
  border-top-color: var(--accent);
  animation: spin 1s linear infinite;
  box-shadow: 0 0 20px rgba(113,248,252,0.45);
}

body.night .loader {
  border: 6px solid rgba(255,255,255,0.14);
  box-shadow: 0 0 24px rgba(62,237,231,0.55);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#loading p {
  color: var(--text-main);
  font-size: 0.9rem;
  opacity: 0.8;
}

/* ================= 横屏适配 ================= */
@media (orientation: landscape) and (max-width: 900px) {
  #gameWrapper {
    align-items: center;
  }

  .overlay {
    flex-direction: row;
    justify-content: center;
    gap: 24px;
  }

  .overlay h1 {
    font-size: 36px;
  }

  .overlay button {
    font-size: 1.1rem;
    padding: 0.7rem 1.8rem;
  }
}

/* ================= iOS 安全区 ================= */
@supports (padding: env(safe-area-inset-bottom)) {
  body {
    padding-bottom: env(safe-area-inset-bottom);
  }

  .overlay {
    padding-bottom: env(safe-area-inset-bottom);
  }
}

/* ================= 移动端适配 ================= */
@media (max-width: 480px) {
  .overlay h1 {
    font-size: 36px;
  }

  .overlay button {
    font-size: 1rem;
    padding: 0.7rem 1.8rem;
  }
}
</style>

</head>

<body class="preload">
<!-- 加载动画（主页同款）-->
<div id="loading">
  <div class="loader"></div>
  <p id="loadingText">加载中...</p>
</div>

<div id="gameWrapper">
  <canvas id="game" role="img" aria-label="游戏画面"></canvas>

  <div class="overlay" id="overlay" role="dialog" aria-labelledby="overText">
    <h1 id="overText">游戏结束</h1>
    <button id="restart" autofocus>再来一局</button>
  </div>
</div>

<script>
/* ================= 自动主题切换（主页同款）================= */
function applyAutoTheme() {
  const hour = new Date().getHours();
  const isNight = hour >= 18 || hour < 6; // 18:00–06:00
  document.body.classList.toggle('night', isNight);
}

// 初始化主题
applyAutoTheme();
// 每10分钟检查一次主题
setInterval(applyAutoTheme, 10 * 60 * 1000);

/* ================= 国际化 ================= */
const i18n = {
  zh: {
    title: "小游戏",
    gameOver: "游戏结束",
    restart: "再来一局",
    loading: "加载中...",
    tapToStart: "点击屏幕开始",
    highScore: "最高"
  },
  en: {
    title: "Mini Game",
    gameOver: "Game Over",
    restart: "Play Again",
    loading: "Loading...",
    tapToStart: "Tap to Start",
    highScore: "Best"
  },
  ja: {
    title: "ミニゲーム",
    gameOver: "ゲームオーバー",
    restart: "もう一度",
    loading: "読み込み中...",
    tapToStart: "タップして開始",
    highScore: "最高"
  }
};

function detectLang(){
  const saved = localStorage.getItem("lang");
  if (saved && i18n[saved]) return saved;

  const nav = navigator.language || "zh";
  if (nav.startsWith("ja")) return "ja";
  if (nav.startsWith("en")) return "en";
  return "zh";
}

const LANG = detectLang();
const T = i18n[LANG] || i18n.zh;

/* ================= 游戏配置 ================= */
const CONFIG = {
  LOGIC_W: 400,
  LOGIC_H: 650,
  GRAVITY: 0.30,
  JUMP_FORCE: -5.2,
  PIPE_GAP: 170,
  PIPE_WIDTH: 65,
  PIPE_SPACING: 240,
  PIPE_SPEED: 2.8,
  MAX_FALL_SPEED: 12,
  BIRD_SIZE: 34,
  BIRD_START_X: 60,
  BIRD_START_Y: 300,
  COLLISION_PADDING: 4,
  GROUND_OFFSET: 10,
  MAX_SCALE: 2.0
};

/* ================= DOM 元素 ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const restartBtn = document.getElementById("restart");
const loadingEl = document.getElementById("loading");

/* ================= 自适应缩放 ================= */
let gameState = 'loading'; // 提前声明，防止 TDZ
let scale = 1;

function resize(){
  const dpr = window.devicePixelRatio || 1;

  const viewportW = window.innerWidth;
  const viewportH = window.innerHeight;
  const isPad = viewportW >= 768 && viewportW < 1024;
  const verticalPadding = isPad ? 0.92 : 0.95;

  const availableW = viewportW * 0.96;
  const availableH = viewportH * verticalPadding;

  const widthBased = availableW / CONFIG.LOGIC_W;
  const heightBased = availableH / CONFIG.LOGIC_H;

  // 统一使用 contain，确保不变形、不裁剪
  scale = Math.min(widthBased, heightBased);

  scale = Math.min(scale, CONFIG.MAX_SCALE);
  scale = Math.max(scale, 0.5);

  // CSS 显示尺寸
  canvas.style.width = CONFIG.LOGIC_W * scale + "px";
  canvas.style.height = CONFIG.LOGIC_H * scale + "px";

  // 实际像素尺寸（高清）
  canvas.width = Math.round(CONFIG.LOGIC_W * scale * dpr);
  canvas.height = Math.round(CONFIG.LOGIC_H * scale * dpr);

  // 如果游戏已开始，重绘当前帧
  if(typeof gameState !== 'undefined' && gameState !== 'loading') {
    draw();
  }
}

window.addEventListener("resize", resize);
resize();

/* ================= 资源加载 ================= */
const birdImg = new Image();
let assetsLoaded = false;

function loadAssets(){
  return new Promise((resolve) => {
    let resolved = false;
    
    const finishLoading = () => {
      if(!resolved){
        resolved = true;
        resolve();
      }
    };
    
    birdImg.onload = () => {
      console.log('Bird image loaded successfully');
      assetsLoaded = true;
      finishLoading();
    };
    
    birdImg.onerror = (e) => {
      console.warn('Bird image failed to load, using fallback style');
      assetsLoaded = false;
      finishLoading();
    };
    
    // 超时降级（1.5秒）
    setTimeout(() => {
      if(!resolved){
        console.warn('Image loading timeout, starting game anyway');
        assetsLoaded = false;
        finishLoading();
      }
    }, 1500);
    
    // 开始加载
    birdImg.src = "p/bird.png";
  });
}

/* ================= 游戏状态 ================= */
// let gameState = 'loading'; // loading, ready, playing, gameOver  // 已提前声明于前面
let player, pipes, score, highScore, rafId;

highScore = Number(localStorage.getItem("highScore")) || 0;

/* ================= 初始化游戏 ================= */
function resetGame(){
  player = {
    x: CONFIG.BIRD_START_X,
    y: CONFIG.BIRD_START_Y,
    size: CONFIG.BIRD_SIZE,
    dy: 0,
    angle: 0
  };
  
  pipes = [];
  score = 0;
  gameState = 'ready';
  overlay.style.display = "none";

  // 初始化管道
  for(let i = 0; i < 2; i++){
    createPipe(CONFIG.LOGIC_W + 100 + i * CONFIG.PIPE_SPACING);
  }

  cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}

/* ================= 管道生成 ================= */
function createPipe(x){
  const min = 50;
  const max = CONFIG.LOGIC_H - CONFIG.PIPE_GAP - 120;
  const top = Math.random() * (max - min) + min;

  pipes.push({ x, top, passed: false });
}

/* ================= 碰撞检测 ================= */
function hit(a, b){
  const pad = CONFIG.COLLISION_PADDING;
  return !(
    a.x + a.w - pad < b.x ||
    a.x + pad > b.x + b.w ||
    a.y + a.h - pad < b.y ||
    a.y + pad > b.y + b.h
  );
}

/* ================= 游戏逻辑更新 ================= */
function update(){
  if(gameState !== 'playing') return;

  // 重力和速度限制
  player.dy += CONFIG.GRAVITY;
  if(player.dy > CONFIG.MAX_FALL_SPEED) player.dy = CONFIG.MAX_FALL_SPEED;
  player.y += player.dy;

  // 生成新管道
  if(pipes[pipes.length - 1].x < CONFIG.LOGIC_W - CONFIG.PIPE_SPACING){
    createPipe(CONFIG.LOGIC_W + 50);
  }

  // 移动管道
  pipes.forEach(p => p.x -= CONFIG.PIPE_SPEED);
  pipes = pipes.filter(p => p.x + CONFIG.PIPE_WIDTH > -100);

  // 碰撞检测
  const birdBox = {
    x: player.x,
    y: player.y,
    w: player.size,
    h: player.size
  };

  for(const p of pipes){
    const topBox = {
      x: p.x,
      y: 0,
      w: CONFIG.PIPE_WIDTH,
      h: p.top
    };
    const botBox = {
      x: p.x,
      y: p.top + CONFIG.PIPE_GAP,
      w: CONFIG.PIPE_WIDTH,
      h: CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    };

    if(hit(birdBox, topBox) || hit(birdBox, botBox)){
      endGame();
      return;
    }

    // 计分（仅在游戏进行中）
    if(
      gameState === 'playing' &&
      !p.passed &&
      player.x + player.size / 2 > p.x + CONFIG.PIPE_WIDTH / 2
    ){
      score++;
      p.passed = true;
    }
  }

  // 边界检测
  if(player.y + player.size > CONFIG.LOGIC_H - CONFIG.GROUND_OFFSET || player.y < -player.size){
    endGame();
    return;
  }

  // 角度计算
  player.angle = Math.max(-0.35, Math.min(Math.PI / 2, player.dy * 0.12));
}

/* ================= 绘制画面 ================= */
function draw(){
  const dpr = window.devicePixelRatio || 1;
  ctx.setTransform(scale * dpr, 0, 0, scale * dpr, 0, 0);
  ctx.clearRect(0, 0, CONFIG.LOGIC_W, CONFIG.LOGIC_H);

  // 绘制管道
  ctx.fillStyle = "#5cb85c";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, CONFIG.PIPE_WIDTH, p.top);
    ctx.fillRect(
      p.x,
      p.top + CONFIG.PIPE_GAP,
      CONFIG.PIPE_WIDTH,
      CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    );
  });

  // 绘制小鸟
  ctx.save();
  ctx.translate(player.x + player.size / 2, player.y + player.size / 2);
  ctx.rotate(player.angle);

  if(assetsLoaded && birdImg.complete){
    ctx.drawImage(birdImg, -player.size / 2, -player.size / 2, player.size, player.size);
  } else {
    // 降级样式
    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
  }
  ctx.restore();

  // 绘制分数
  ctx.fillStyle = "#fff";
  ctx.font = "900 42px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(score, CONFIG.LOGIC_W / 2, 60);

  // 绘制最高分
  ctx.font = "600 20px sans-serif";
  ctx.fillText(`${T.highScore}: ${highScore}`, CONFIG.LOGIC_W / 2, 110);

  // 绘制开始提示
  if(gameState === 'ready'){
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(0, CONFIG.LOGIC_H / 2 - 50, CONFIG.LOGIC_W, 100);
    
    ctx.fillStyle = "#fff";
    ctx.font = "bold 24px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(T.tapToStart, CONFIG.LOGIC_W / 2, CONFIG.LOGIC_H / 2);
  }
}

/* ================= 主循环 ================= */
function loop(){
  update();
  draw();
  if(gameState !== 'gameOver') {
    rafId = requestAnimationFrame(loop);
  }
}

/* ================= 游戏结束 ================= */
function endGame(){
  if(gameState === 'gameOver') return;
  gameState = 'gameOver';

  // 更新最高分
  if(score > highScore){
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }

  overlay.style.display = "flex";
}

/* ================= 输入处理 ================= */
function jump(e){
  if(e && (e.code === "Space" || e.type.startsWith("touch"))) e.preventDefault();
  
  if(gameState === 'ready'){
    // 开始游戏
    gameState = 'playing';
  }
  
  if(gameState === 'playing'){
    player.dy = CONFIG.JUMP_FORCE;
  }
}

function handleTouchMove(e){
  if (e.target === canvas && gameState !== 'gameOver') {
    e.preventDefault();
  }
}

function handleTouchEnd(e){
  if (e.target === canvas) {
    e.preventDefault();
  }
}

document.addEventListener("keydown", jump);
document.addEventListener("mousedown", jump);
canvas.addEventListener("touchstart", jump, { passive: false });
canvas.addEventListener("touchmove", handleTouchMove, { passive: false });
canvas.addEventListener("touchend", handleTouchEnd, { passive: false });

restartBtn.onclick = e => {
  e.stopPropagation();
  resetGame();
};

/* ================= iOS Safari 特殊适配 ================= */
if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
  document.body.addEventListener("touchmove", handleTouchMove, { passive: false });

  // 强制重新计算尺寸（解决横竖屏切换高度不准）
  window.addEventListener("orientationchange", () => {
    setTimeout(resize, 300);
  });
}

/* ================= 启动游戏 ================= */
window.addEventListener('load', async function() {
  try {
    // 更新 UI 文本
    document.title = T.title;
    document.getElementById("overText").textContent = T.gameOver;
    document.getElementById("restart").textContent = T.restart;
    loadingEl.querySelector('p').textContent = T.loading;

    console.log('Starting to load assets...');
    
    // 加载资源
    await loadAssets();

    console.log('Assets loaded, starting game...');

    // 移除 preload 类，显示页面
    document.body.classList.remove('preload');
    document.body.style.opacity = '1';

    // 隐藏加载画面（主页同款动画）
    loadingEl.style.opacity = '0';
    setTimeout(() => loadingEl.remove(), 600);

    // 启动游戏
    resetGame();
    
    console.log('Game initialized successfully');
  } catch(error) {
    console.error('Initialization error:', error);
    // 即使出错也隐藏加载画面并启动游戏
    document.body.classList.remove('preload');
    loadingEl.style.opacity = '0';
    setTimeout(() => loadingEl.remove(), 600);
    resetGame();
  }
});
</script>

</body>
</html>
