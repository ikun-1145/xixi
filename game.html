<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>小游戏</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC",
  "Microsoft YaHei",Arial,sans-serif;
  background:url("p/chengshi.png") center/cover no-repeat fixed #87CEEB;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
}

#gameWrapper{position:relative;margin-top:2vh}
canvas{
  border-radius:12px;
  box-shadow:0 10px 20px rgba(0,0,0,.25);
}

.overlay{
  position:absolute;
  inset:0;
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:16px;
  background:rgba(0,0,0,.35);
}

.overlay h1{
  color:#fff;
  font-size:48px;
  text-shadow:2px 2px 0 #000;
}

.overlay button{
  padding:.8rem 2.2rem;
  font-size:1.2rem;
  font-weight:700;
  border-radius:30px;
  border:2px solid #fff;
  background:linear-gradient(#71f8fc,#40e0d0);
  color:#004d4d;
}
</style>
</head>

<body>
<div id="gameWrapper">
  <canvas id="game"></canvas>

  <div class="overlay" id="overlay">
    <h1 id="overText">游戏结束</h1>
    <button id="restart">再来一局</button>
  </div>
</div>

<script>
const i18n = {
  zh: {
    title: "小游戏",
    gameOver: "游戏结束",
    restart: "再来一局"
  },
  en: {
    title: "Mini Game",
    gameOver: "Game Over",
    restart: "Play Again"
  },
  ja: {
    title: "ミニゲーム",
    gameOver: "ゲームオーバー",
    restart: "もう一度"
  }
};
function detectLang(){
  const saved = localStorage.getItem("lang");
  if (saved) return saved;

  const nav = navigator.language || "zh";
  if (nav.startsWith("ja")) return "ja";
  if (nav.startsWith("en")) return "en";
  return "zh";
}

const LANG = detectLang();
const T = i18n[LANG] || i18n.zh;
document.title = T.title;
document.getElementById("overText").textContent = T.gameOver;
document.getElementById("restart").textContent = T.restart;
/* ================= 基础配置 ================= */
const LOGIC_W = 400;
const LOGIC_H = 650;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const restartBtn = document.getElementById("restart");

/* ================= 自适应 ================= */
let scale = 1;

function resize(){
  const h = window.innerHeight * 0.95;
  scale = Math.min(window.innerWidth / LOGIC_W, h / LOGIC_H, 1.5);

  canvas.width = LOGIC_W * scale;
  canvas.height = LOGIC_H * scale;
}
window.addEventListener("resize", resize);
resize();

/* ================= 资源 ================= */
const birdImg = new Image();
birdImg.src = "p/bird.png";

/* ================= 游戏状态 ================= */
let player, pipes, score, highScore, gameOver, rafId;

const gravity = 0.30;
const jumpForce = -5.2;
const pipeGap = 170;
const pipeWidth = 65;
const pipeSpacing = 240;
const pipeSpeed = 2.8;

highScore = Number(localStorage.getItem("highScore")) || 0;

/* ================= 初始化 ================= */
function resetGame(){
  player = { x:60, y:300, size:34, dy:0, angle:0 };
  pipes = [];
  score = 0;
  gameOver = false;
  overlay.style.display = "none";

  for(let i=0;i<2;i++){
    createPipe(LOGIC_W + 100 + i * pipeSpacing);
  }

  cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}

/* ================= 管道 ================= */
function createPipe(x){
  const min = 50;
  const max = LOGIC_H - pipeGap - 120;
  const top = Math.random() * (max - min) + min;

  pipes.push({ x, top, passed:false });
}

/* ================= 碰撞 ================= */
function hit(a,b){
  const pad = 4;
  return !(
    a.x+a.w-pad < b.x ||
    a.x+pad > b.x+b.w ||
    a.y+a.h-pad < b.y ||
    a.y+pad > b.y+b.h
  );
}

/* ================= 更新 ================= */
function update(){
  player.dy += gravity;
  if(player.dy > 12) player.dy = 12;
  player.y += player.dy;

  if(pipes[pipes.length-1].x < LOGIC_W - pipeSpacing){
    createPipe(LOGIC_W + 50);
  }

  pipes.forEach(p=>p.x -= pipeSpeed);
  pipes = pipes.filter(p=>p.x + pipeWidth > -100);

  const birdBox = { x:player.x,y:player.y,w:player.size,h:player.size };

  for(const p of pipes){
    const topBox = { x:p.x,y:0,w:pipeWidth,h:p.top };
    const botBox = {
      x:p.x,
      y:p.top+pipeGap,
      w:pipeWidth,
      h:LOGIC_H-(p.top+pipeGap)
    };

    if(hit(birdBox,topBox) || hit(birdBox,botBox)){
      endGame();
    }

    if(!p.passed && player.x+player.size/2 > p.x+pipeWidth/2){
      score++;
      p.passed = true;
    }
  }

  if(player.y + player.size > LOGIC_H-10 || player.y < -player.size){
    endGame();
  }

  player.angle = Math.max(-0.35, Math.min(Math.PI/2, player.dy*0.12));
}

/* ================= 绘制 ================= */
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.scale(scale,scale);

  // 管道
  ctx.fillStyle="#5cb85c";
  pipes.forEach(p=>{
    ctx.fillRect(p.x,0,pipeWidth,p.top);
    ctx.fillRect(
      p.x,
      p.top+pipeGap,
      pipeWidth,
      LOGIC_H-(p.top+pipeGap)
    );
  });

  // 鸟
  ctx.save();
  ctx.translate(player.x+player.size/2,player.y+player.size/2);
  ctx.rotate(player.angle);

  if(birdImg.complete){
    ctx.drawImage(birdImg,-player.size/2,-player.size/2,player.size,player.size);
  }else{
    ctx.fillStyle="#ffcc00";
    ctx.fillRect(-player.size/2,-player.size/2,player.size,player.size);
  }
  ctx.restore();

  // 分数
  ctx.fillStyle="#fff";
  ctx.font="900 42px sans-serif";
  ctx.textAlign="center";
  ctx.fillText(score,LOGIC_W/2,60);
}

/* ================= 主循环 ================= */
function loop(){
  update();
  draw();
  if(!gameOver) rafId = requestAnimationFrame(loop);
}

/* ================= 结束 ================= */
function endGame(){
  if(gameOver) return;
  gameOver = true;

  highScore = Math.max(highScore, score);
  localStorage.setItem("highScore", highScore);

  overlay.style.display = "flex";
}

/* ================= 输入 ================= */
function jump(e){
  if(e?.code==="Space") e.preventDefault();
  if(!gameOver) player.dy = jumpForce;
}
document.addEventListener("keydown", jump);
document.addEventListener("mousedown", jump);
document.addEventListener("touchstart", jump, {passive:false});

restartBtn.onclick = e=>{
  e.stopPropagation();
  resetGame();
};

/* ================= 启动 ================= */
birdImg.onload = resetGame;
setTimeout(resetGame,200); // 兜底
</script>
</body>
</html>