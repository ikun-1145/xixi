<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>小游戏</title>
<link href="https://fonts.googleapis.com/css2?family=Product+Sans&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Product Sans',sans-serif;
    background: url('p/chengshi.png') center center / cover no-repeat fixed;
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;color:#1A1A1A;overflow:hidden;
  }
  #gameCanvas{
    display:block;
    margin:0 auto;
    background: transparent;
    border-radius:12px;
    image-rendering: pixelated;
  }
  .buttons{
    display:none;
    gap:1rem;
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    z-index:10;
    flex-direction:column;
    align-items:center;
  }
  .buttons button,.buttons a{
    padding:.8rem 1.5rem;
    background:linear-gradient(to right,#71f8fc,#a0fff8);
    border-radius:30px;color:black;font-weight:bold;font-size:1.1rem;border:none;cursor:pointer;margin:.5rem 0;
  }
</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div class="buttons" id="buttonsContainer">
    <button id="restartBtn">重新开始</button>
    <a href="index.html">返回主页</a>
  </div>

<script>
/* --------- 初始化 --------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: true });
const buttonsContainer = document.getElementById('buttonsContainer');

/* 逻辑分辨率（游戏内部坐标系） */
const LOGIC_WIDTH = 400;
const LOGIC_HEIGHT = 650;
let scale = 1;

/* 屏幕适配 */
function resizeCanvas(){
  const maxWidth = window.innerWidth;
  const maxHeight = window.innerHeight;
  const scaleX = maxWidth / LOGIC_WIDTH;
  const scaleY = maxHeight / LOGIC_HEIGHT;
  scale = Math.min(scaleX, scaleY); // 保持比例缩放

  canvas.width = LOGIC_WIDTH * scale;
  canvas.height = LOGIC_HEIGHT * scale;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* 加载鸟的图片 */
const birdImg = new Image();
birdImg.src = 'p/bird.png';

let player = { x:50, y:250, size:30, dy:0 };
let gravity = 0.3;
let jump = -6;
let pipes = [];
let pipeWidth = 60;
let pipeGap = 180;
let pipeSpacing = 250;
let score = 0;
let gameOver = false;
let animationId;

/* --------- 最高分处理 --------- */
let highScore = parseInt(localStorage.getItem('highScore')) || 0;

function updateHighScore(){
  if(score > highScore){
    highScore = score;
    localStorage.setItem('highScore', highScore);
  }
}

/* --------- 帮助函数 --------- */
function createPipeAt(x){
  const topHeight = Math.floor(Math.random() * (LOGIC_HEIGHT - pipeGap - 50)) + 25;
  pipes.push({ x, topHeight, passed:false });
}

function resetGame(){
  player.y = LOGIC_HEIGHT / 2;
  player.dy = 0;
  pipes = [];
  score = 0;
  gameOver = false;
  buttonsContainer.style.display = 'none';
  cancelAnimationFrame(animationId);
  const startX = LOGIC_WIDTH;
  for(let i=0;i<3;i++){
    createPipeAt(startX + i * pipeSpacing);
  }
  animate();
}

/* --------- 绘制 --------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.scale(scale, scale);  // 缩放到逻辑坐标系

  // 管子
  ctx.fillStyle = '#2b7a78';
  for(const p of pipes){
    ctx.fillRect(p.x, 0, pipeWidth, p.topHeight);
    ctx.fillRect(p.x, p.topHeight + pipeGap, pipeWidth, LOGIC_HEIGHT - (p.topHeight + pipeGap));
  }

  // 玩家（小鸟图片）
  ctx.drawImage(birdImg, player.x, player.y, player.size, player.size);

  // 分数
  ctx.fillStyle = '#1A1A1A';
  ctx.font = '20px Product Sans';
  ctx.textAlign = 'left';
  ctx.fillText(`分数: ${score}`, 10, 30);
  ctx.fillText(`最高分: ${highScore}`, 10, 60);

  // 游戏结束
  if(gameOver){
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0,0,LOGIC_WIDTH,LOGIC_HEIGHT);
    ctx.fillStyle = '#fff';
    ctx.font = `${Math.floor(LOGIC_WIDTH/10)}px Product Sans`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('游戏结束', LOGIC_WIDTH/2, LOGIC_HEIGHT/2);

    // 更新最高分
    updateHighScore();
  }

  ctx.restore();
}

/* --------- 更新 --------- */
function update(){
  if(gameOver) return;
  player.dy += gravity;
  player.y += player.dy;

  if(pipes.length === 0 || (pipes[pipes.length-1].x < LOGIC_WIDTH - pipeSpacing)){
    createPipeAt(LOGIC_WIDTH);
  }
  for(const p of pipes) p.x -= 2;
  pipes = pipes.filter(p => p.x + pipeWidth > 0);

  for(const p of pipes){
    if(player.x + player.size > p.x && player.x < p.x + pipeWidth){
      if(player.y < p.topHeight || player.y + player.size > p.topHeight + pipeGap){
        endGame();
      }
    }
    if(!p.passed && player.x > p.x + pipeWidth){
      score++;
      p.passed = true;
    }
  }
  if(player.y + player.size > LOGIC_HEIGHT || player.y < 0){
    endGame();
  }
}

/* --------- 动画 --------- */
function animate(){
  update();
  draw();
  if(!gameOver){
    animationId = requestAnimationFrame(animate);
  } else {
    buttonsContainer.style.display = 'flex';
  }
}

/* --------- 事件 --------- */
function endGame(){
  gameOver = true;
  draw();
}
document.addEventListener('keydown', e => {
  if(e.code === 'Space' && !gameOver) player.dy = jump;
});
document.addEventListener('click', () => {
  if(!gameOver) player.dy = jump;
});
document.getElementById('restartBtn').addEventListener('click', resetGame);

/* 启动 */
resetGame();
</script>
</body>
</html>