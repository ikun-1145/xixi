<!DOCTYPE html>

<html lang="zh-Hans">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>å°æ¸¸æˆ</title>

<link rel="preload" as="image" href="p/chengshi.webp" type="image/webp">
<link rel="preload" as="image" href="p/chengshi.png">
<link rel="preload" as="image" href="p/bird.png">

<style>
/* ================= CSS å˜é‡ï¼ˆä¸»é¡µåŒæ¬¾ï¼‰================= */
:root {
  --bg-main: linear-gradient(135deg, #dcefff, #f8fdff), url('p/chengshi.png') center / cover no-repeat;
  --card-bg: rgba(255,255,255,0.5);
  --text-main: #1A1A1A;
  --accent: #71f8fc;
}

body.night {
  --bg-main: #161823;
  --card-bg: rgba(22,24,35,0.95);
  --text-main: #E8FFFF;
  --accent: #3EEDE7;
}

/* ================= åŸºç¡€æ ·å¼ ================= */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body.preload {
  opacity: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
               "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC",
               "Source Han Sans SC", Arial, sans-serif;
  background: var(--bg-main);
  min-height: 100vh;
  min-height: 100svh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  color: var(--text-main);
  transition: opacity 0.8s ease;
}

@supports (background-image: url("p/chengshi.webp")) {
  :root {
    --bg-main: linear-gradient(135deg, #dcefff, #f8fdff), url('p/chengshi.webp') center / cover no-repeat;
  }
}

/* ä¸»é¡µåŒæ¬¾ç²’å­åŠ¨ç”»èƒŒæ™¯ */
body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.45) 0, rgba(255,255,255,0) 60%),
    radial-gradient(circle at 80% 70%, rgba(255,255,255,0.38) 0, rgba(255,255,255,0) 60%),
    radial-gradient(circle at 40% 80%, rgba(255,255,255,0.42) 0, rgba(255,255,255,0) 60%);
  background-size: 120% 120%;
  animation: floatParticles 18s ease-in-out infinite alternate;
  pointer-events: none;
  z-index: -1;
}

body.night::before {
  background:
    radial-gradient(circle at 30% 30%, rgba(62,237,231,0.12), transparent 60%),
    radial-gradient(circle at 70% 70%, rgba(62,237,231,0.08), transparent 60%);
}

@keyframes floatParticles {
  0% { background-position: 0% 0%; }
  100% { background-position: 100% 100%; }
}

/* ================= æ¸¸æˆå®¹å™¨ ================= */
#gameWrapper {
  position: relative;
  margin: 2vh auto;
  display: flex;
  justify-content: center;
  animation: fadeInUp 1s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

canvas {
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(80, 140, 200, 0.25), 
              inset 0 0 40px rgba(200, 240, 255, 0.4), 
              0 10px 30px rgba(0,0,0,0.08);
  touch-action: none;
  animation: float 6s ease-in-out infinite;
}

@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
  100% { transform: translateY(0); }
}

/* ================= æ¸¸æˆç»“æŸé®ç½©ï¼ˆä¸»é¡µåŒæ¬¾æ¯›ç»ç’ƒï¼‰================= */
.overlay {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 20px;
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 16px;
}

/* å…¼å®¹æ€§å…œåº• */
@supports not ((backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px))) {
  .overlay {
    background: rgba(255,255,255,0.9);
  }
  body.night .overlay {
    background: rgba(22,24,35,0.95);
  }
}

.overlay h1 {
  color: var(--text-main);
  font-size: 48px;
  text-shadow: 0 0 20px rgba(113, 248, 252, 0.3);
  animation: modalPop 0.5s ease;
}

@keyframes modalPop {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* ================= æŒ‰é’®æ ·å¼ï¼ˆä¸»é¡µåŒæ¬¾ï¼‰================= */
.overlay button {
  padding: 0.8rem 2.2rem;
  font-size: 1.2rem;
  font-weight: 700;
  border-radius: 30px;
  border: none;
  background: var(--accent);
  color: #000;
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
  animation: breatheGlow 3s ease-in-out infinite;
  box-shadow: 0 0 12px rgba(113, 248, 252, 0.35);
}

@keyframes breatheGlow {
  0% { box-shadow: 0 0 12px rgba(113, 248, 252, 0.35); }
  50% { box-shadow: 0 0 22px rgba(113, 248, 252, 0.55); }
  100% { box-shadow: 0 0 12px rgba(113, 248, 252, 0.35); }
}

.overlay button:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 28px rgba(80, 160, 255, 0.35);
  filter: brightness(1.08);
}

.overlay button:active {
  transform: translateY(-1px);
}

/* ================= åŠ è½½åŠ¨ç”»ï¼ˆä¸»é¡µåŒæ¬¾ï¼‰================= */
#loading {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  transition: opacity 0.6s ease;
  background: radial-gradient(
    circle at center,
    rgba(113,248,252,0.18),
    #ffffff 65%
  );
}

body.night #loading {
  background: radial-gradient(
    circle at center,
    rgba(62,237,231,0.14),
    rgba(22,24,35,0.96) 65%
  );
}

.loader {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: 6px solid rgba(0,0,0,0.08);
  border-top-color: var(--accent);
  animation: spin 1s linear infinite;
  box-shadow: 0 0 20px rgba(113,248,252,0.45);
}

body.night .loader {
  border: 6px solid rgba(255,255,255,0.14);
  box-shadow: 0 0 24px rgba(62,237,231,0.55);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#loading p {
  color: var(--text-main);
  font-size: 0.9rem;
  opacity: 0.8;
}

/* ================= æ¨ªå±é€‚é… ================= */
@media (orientation: landscape) and (max-width: 900px) {
  #gameWrapper {
    align-items: center;
  }

  .overlay {
    flex-direction: row;
    justify-content: center;
    gap: 24px;
  }

  .overlay h1 {
    font-size: 36px;
  }

  .overlay button {
    font-size: 1.1rem;
    padding: 0.7rem 1.8rem;
  }
}

/* ================= iOS å®‰å…¨åŒº ================= */
@supports (padding: env(safe-area-inset-bottom)) {
  body {
    padding-bottom: env(safe-area-inset-bottom);
  }

  .overlay {
    padding-bottom: env(safe-area-inset-bottom);
  }
}

/* ================= ç§»åŠ¨ç«¯é€‚é… ================= */
@media (max-width: 480px) {
  .overlay h1 {
    font-size: 36px;
  }

  .overlay button {
    font-size: 1rem;
    padding: 0.7rem 1.8rem;
  }
}
</style>

</head>

<body class="preload">
<!-- åŠ è½½åŠ¨ç”»ï¼ˆä¸»é¡µåŒæ¬¾ï¼‰-->
<div id="loading">
  <div class="loader"></div>
  <p id="loadingText">åŠ è½½ä¸­...</p>
</div>

<div id="gameWrapper">
  <canvas id="game" role="img" aria-label="æ¸¸æˆç”»é¢"></canvas>

  <div class="overlay" id="overlay" role="dialog" aria-labelledby="overText">
    <h1 id="overText">æ¸¸æˆç»“æŸ</h1>
    <button id="restart" autofocus>å†æ¥ä¸€å±€</button>
  </div>
</div>

<script>
/* ================= è‡ªåŠ¨ä¸»é¢˜åˆ‡æ¢ï¼ˆä¸»é¡µåŒæ¬¾ï¼‰================= */
function applyAutoTheme() {
  const hour = new Date().getHours();
  const isNight = hour >= 18 || hour < 6; // 18:00â€“06:00
  document.body.classList.toggle('night', isNight);
}

// åˆå§‹åŒ–ä¸»é¢˜
applyAutoTheme();
// æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä¸»é¢˜
setInterval(applyAutoTheme, 10 * 60 * 1000);

/* ================= å›½é™…åŒ– ================= */
const i18n = {
  zh: {
    title: "å°æ¸¸æˆ",
    gameOver: "æ¸¸æˆç»“æŸ",
    restart: "å†æ¥ä¸€å±€",
    loading: "åŠ è½½ä¸­...",
    tapToStart: "ç‚¹å‡»å±å¹•å¼€å§‹",
    highScore: "æœ€é«˜"
  },
  en: {
    title: "Mini Game",
    gameOver: "Game Over",
    restart: "Play Again",
    loading: "Loading...",
    tapToStart: "Tap to Start",
    highScore: "Best"
  },
  ja: {
    title: "ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ",
    gameOver: "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼",
    restart: "ã‚‚ã†ä¸€åº¦",
    loading: "èª­ã¿è¾¼ã¿ä¸­...",
    tapToStart: "ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹",
    highScore: "æœ€é«˜"
  }
};

function detectLang(){
  const saved = localStorage.getItem("lang");
  if (saved && i18n[saved]) return saved;

  const nav = navigator.language || "zh";
  if (nav.startsWith("ja")) return "ja";
  if (nav.startsWith("en")) return "en";
  return "zh";
}

const LANG = detectLang();
const T = i18n[LANG] || i18n.zh;

/* ================= æ¸¸æˆé…ç½® ================= */
const CONFIG = {
  LOGIC_W: 400,
  LOGIC_H: 650,
  GRAVITY: 0.30,
  JUMP_FORCE: -5.2,
  PIPE_GAP: 170,
  PIPE_WIDTH: 65,
  PIPE_SPACING: 240,
  PIPE_SPEED: 2.8,
  MAX_FALL_SPEED: 12,
  BIRD_SIZE: 34,
  BIRD_START_X: 60,
  BIRD_START_Y: 300,
  COLLISION_PADDING: 4,
  GROUND_OFFSET: 10,
  MAX_SCALE: 2.0
};

/* ================= DOM å…ƒç´  ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const restartBtn = document.getElementById("restart");
const loadingEl = document.getElementById("loading");

/* ================= è‡ªé€‚åº”ç¼©æ”¾ ================= */
let gameState = 'loading'; // æå‰å£°æ˜ï¼Œé˜²æ­¢ TDZ
let scale = 1;

function resize(){
  const dpr = window.devicePixelRatio || 1;

  const availableW = window.innerWidth;
  const availableH = window.innerHeight * 0.95;

  let widthBased = availableW / CONFIG.LOGIC_W;
  let heightBased = availableH / CONFIG.LOGIC_H;

  // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯ï¼ˆè§¦æ§ä¸ºä¸» or çª„å±ï¼‰
  const isMobile =
    window.matchMedia("(pointer: coarse)").matches ||
    Math.min(availableW, availableH) < 700;

  // ğŸ“± æ‰‹æœºï¼šcoverï¼ˆé“ºæ»¡ï¼‰
  // ğŸ’» ç”µè„‘ï¼šcontainï¼ˆå®Œæ•´æ˜¾ç¤ºï¼‰
  if (isMobile) {
    scale = Math.max(widthBased, heightBased);
  } else {
    scale = Math.min(widthBased, heightBased);
  }

  scale = Math.min(scale, CONFIG.MAX_SCALE);

  // CSS æ˜¾ç¤ºå°ºå¯¸
  canvas.style.width = CONFIG.LOGIC_W * scale + "px";
  canvas.style.height = CONFIG.LOGIC_H * scale + "px";

  // å®é™…åƒç´ å°ºå¯¸ï¼ˆé«˜æ¸…ï¼‰
  canvas.width = Math.round(CONFIG.LOGIC_W * scale * dpr);
  canvas.height = Math.round(CONFIG.LOGIC_H * scale * dpr);

  // å¦‚æœæ¸¸æˆå·²å¼€å§‹ï¼Œé‡ç»˜å½“å‰å¸§
  if(typeof gameState !== 'undefined' && gameState !== 'loading') {
    draw();
  }
}

window.addEventListener("resize", resize);
resize();

/* ================= èµ„æºåŠ è½½ ================= */
const birdImg = new Image();
let assetsLoaded = false;

function loadAssets(){
  return new Promise((resolve) => {
    let resolved = false;
    
    const finishLoading = () => {
      if(!resolved){
        resolved = true;
        resolve();
      }
    };
    
    birdImg.onload = () => {
      console.log('Bird image loaded successfully');
      assetsLoaded = true;
      finishLoading();
    };
    
    birdImg.onerror = (e) => {
      console.warn('Bird image failed to load, using fallback style');
      assetsLoaded = false;
      finishLoading();
    };
    
    // è¶…æ—¶é™çº§ï¼ˆ1.5ç§’ï¼‰
    setTimeout(() => {
      if(!resolved){
        console.warn('Image loading timeout, starting game anyway');
        assetsLoaded = false;
        finishLoading();
      }
    }, 1500);
    
    // å¼€å§‹åŠ è½½
    birdImg.src = "p/bird.png";
  });
}

/* ================= æ¸¸æˆçŠ¶æ€ ================= */
// let gameState = 'loading'; // loading, ready, playing, gameOver  // å·²æå‰å£°æ˜äºå‰é¢
let player, pipes, score, highScore, rafId;

highScore = Number(localStorage.getItem("highScore")) || 0;

/* ================= åˆå§‹åŒ–æ¸¸æˆ ================= */
function resetGame(){
  player = {
    x: CONFIG.BIRD_START_X,
    y: CONFIG.BIRD_START_Y,
    size: CONFIG.BIRD_SIZE,
    dy: 0,
    angle: 0
  };
  
  pipes = [];
  score = 0;
  gameState = 'ready';
  overlay.style.display = "none";

  // åˆå§‹åŒ–ç®¡é“
  for(let i = 0; i < 2; i++){
    createPipe(CONFIG.LOGIC_W + 100 + i * CONFIG.PIPE_SPACING);
  }

  cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
}

/* ================= ç®¡é“ç”Ÿæˆ ================= */
function createPipe(x){
  const min = 50;
  const max = CONFIG.LOGIC_H - CONFIG.PIPE_GAP - 120;
  const top = Math.random() * (max - min) + min;

  pipes.push({ x, top, passed: false });
}

/* ================= ç¢°æ’æ£€æµ‹ ================= */
function hit(a, b){
  const pad = CONFIG.COLLISION_PADDING;
  return !(
    a.x + a.w - pad < b.x ||
    a.x + pad > b.x + b.w ||
    a.y + a.h - pad < b.y ||
    a.y + pad > b.y + b.h
  );
}

/* ================= æ¸¸æˆé€»è¾‘æ›´æ–° ================= */
function update(){
  if(gameState !== 'playing') return;

  // é‡åŠ›å’Œé€Ÿåº¦é™åˆ¶
  player.dy += CONFIG.GRAVITY;
  if(player.dy > CONFIG.MAX_FALL_SPEED) player.dy = CONFIG.MAX_FALL_SPEED;
  player.y += player.dy;

  // ç”Ÿæˆæ–°ç®¡é“
  if(pipes[pipes.length - 1].x < CONFIG.LOGIC_W - CONFIG.PIPE_SPACING){
    createPipe(CONFIG.LOGIC_W + 50);
  }

  // ç§»åŠ¨ç®¡é“
  pipes.forEach(p => p.x -= CONFIG.PIPE_SPEED);
  pipes = pipes.filter(p => p.x + CONFIG.PIPE_WIDTH > -100);

  // ç¢°æ’æ£€æµ‹
  const birdBox = {
    x: player.x,
    y: player.y,
    w: player.size,
    h: player.size
  };

  for(const p of pipes){
    const topBox = {
      x: p.x,
      y: 0,
      w: CONFIG.PIPE_WIDTH,
      h: p.top
    };
    const botBox = {
      x: p.x,
      y: p.top + CONFIG.PIPE_GAP,
      w: CONFIG.PIPE_WIDTH,
      h: CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    };

    if(hit(birdBox, topBox) || hit(birdBox, botBox)){
      endGame();
      return;
    }

    // è®¡åˆ†ï¼ˆä»…åœ¨æ¸¸æˆè¿›è¡Œä¸­ï¼‰
    if(
      gameState === 'playing' &&
      !p.passed &&
      player.x + player.size / 2 > p.x + CONFIG.PIPE_WIDTH / 2
    ){
      score++;
      p.passed = true;
    }
  }

  // è¾¹ç•Œæ£€æµ‹
  if(player.y + player.size > CONFIG.LOGIC_H - CONFIG.GROUND_OFFSET || player.y < -player.size){
    endGame();
    return;
  }

  // è§’åº¦è®¡ç®—
  player.angle = Math.max(-0.35, Math.min(Math.PI / 2, player.dy * 0.12));
}

/* ================= ç»˜åˆ¶ç”»é¢ ================= */
function draw(){
  const dpr = window.devicePixelRatio || 1;
  ctx.setTransform(scale * dpr, 0, 0, scale * dpr, 0, 0);
  ctx.clearRect(0, 0, CONFIG.LOGIC_W, CONFIG.LOGIC_H);

  // ç»˜åˆ¶ç®¡é“
  ctx.fillStyle = "#5cb85c";
  pipes.forEach(p => {
    ctx.fillRect(p.x, 0, CONFIG.PIPE_WIDTH, p.top);
    ctx.fillRect(
      p.x,
      p.top + CONFIG.PIPE_GAP,
      CONFIG.PIPE_WIDTH,
      CONFIG.LOGIC_H - (p.top + CONFIG.PIPE_GAP)
    );
  });

  // ç»˜åˆ¶å°é¸Ÿ
  ctx.save();
  ctx.translate(player.x + player.size / 2, player.y + player.size / 2);
  ctx.rotate(player.angle);

  if(assetsLoaded && birdImg.complete){
    ctx.drawImage(birdImg, -player.size / 2, -player.size / 2, player.size, player.size);
  } else {
    // é™çº§æ ·å¼
    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(-player.size / 2, -player.size / 2, player.size, player.size);
  }
  ctx.restore();

  // ç»˜åˆ¶åˆ†æ•°
  ctx.fillStyle = "#fff";
  ctx.font = "900 42px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(score, CONFIG.LOGIC_W / 2, 60);

  // ç»˜åˆ¶æœ€é«˜åˆ†
  ctx.font = "600 20px sans-serif";
  ctx.fillText(`${T.highScore}: ${highScore}`, CONFIG.LOGIC_W / 2, 110);

  // ç»˜åˆ¶å¼€å§‹æç¤º
  if(gameState === 'ready'){
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(0, CONFIG.LOGIC_H / 2 - 50, CONFIG.LOGIC_W, 100);
    
    ctx.fillStyle = "#fff";
    ctx.font = "bold 24px sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(T.tapToStart, CONFIG.LOGIC_W / 2, CONFIG.LOGIC_H / 2);
  }
}

/* ================= ä¸»å¾ªç¯ ================= */
function loop(){
  update();
  draw();
  if(gameState !== 'gameOver') {
    rafId = requestAnimationFrame(loop);
  }
}

/* ================= æ¸¸æˆç»“æŸ ================= */
function endGame(){
  if(gameState === 'gameOver') return;
  gameState = 'gameOver';

  // æ›´æ–°æœ€é«˜åˆ†
  if(score > highScore){
    highScore = score;
    localStorage.setItem("highScore", highScore);
  }

  overlay.style.display = "flex";
}

/* ================= è¾“å…¥å¤„ç† ================= */
function jump(e){
  if(e && e.code === "Space") e.preventDefault();
  
  if(gameState === 'ready'){
    // å¼€å§‹æ¸¸æˆ
    gameState = 'playing';
  }
  
  if(gameState === 'playing'){
    player.dy = CONFIG.JUMP_FORCE;
  }
}

document.addEventListener("keydown", jump);
document.addEventListener("mousedown", jump);
document.addEventListener("touchstart", jump, { passive: false });

restartBtn.onclick = e => {
  e.stopPropagation();
  resetGame();
};

/* ================= iOS Safari ç‰¹æ®Šé€‚é… ================= */
if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
  document.body.addEventListener("touchmove", e => {
    if (e.target === canvas) e.preventDefault();
  }, { passive: false });

  // å¼ºåˆ¶é‡æ–°è®¡ç®—å°ºå¯¸ï¼ˆè§£å†³æ¨ªç«–å±åˆ‡æ¢é«˜åº¦ä¸å‡†ï¼‰
  window.addEventListener("orientationchange", () => {
    setTimeout(resize, 300);
  });
}

/* ================= å¯åŠ¨æ¸¸æˆ ================= */
window.addEventListener('load', async function() {
  try {
    // æ›´æ–° UI æ–‡æœ¬
    document.title = T.title;
    document.getElementById("overText").textContent = T.gameOver;
    document.getElementById("restart").textContent = T.restart;
    loadingEl.querySelector('p').textContent = T.loading;

    console.log('Starting to load assets...');
    
    // åŠ è½½èµ„æº
    await loadAssets();

    console.log('Assets loaded, starting game...');

    // ç§»é™¤ preload ç±»ï¼Œæ˜¾ç¤ºé¡µé¢
    document.body.classList.remove('preload');
    document.body.style.opacity = '1';

    // éšè—åŠ è½½ç”»é¢ï¼ˆä¸»é¡µåŒæ¬¾åŠ¨ç”»ï¼‰
    loadingEl.style.opacity = '0';
    setTimeout(() => loadingEl.remove(), 600);

    // å¯åŠ¨æ¸¸æˆ
    resetGame();
    
    console.log('Game initialized successfully');
  } catch(error) {
    console.error('Initialization error:', error);
    // å³ä½¿å‡ºé”™ä¹Ÿéšè—åŠ è½½ç”»é¢å¹¶å¯åŠ¨æ¸¸æˆ
    document.body.classList.remove('preload');
    loadingEl.style.opacity = '0';
    setTimeout(() => loadingEl.remove(), 600);
    resetGame();
  }
});
</script>

</body>
</html>