<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æèµ æ”¯æŒ - éœœè“</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="supabaseClient.js"></script>
  <script type="module" src="checkLogin.js"></script>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background-image: url('p/bg.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      margin: 0;
      padding: 0;
    }

    .container {
      position: relative;
      max-width: 800px;
      margin: 80px auto;
      padding: 30px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      box-shadow: 0 0 15px #71f8fc88;
      animation: fadeInUp 1s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      text-align: center;
      color: #71f8fc;
      margin-bottom: 20px;
    }

    .tier-group {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin: 18px 0 10px;
    }

    .tier-btn {
      background: rgba(113,248,252,0.15);
      border: 1px solid rgba(113,248,252,0.6);
      color: #71f8fc;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: .25s;
      font-size: 14px;
    }

    .tier-btn:hover {
      background: rgba(113,248,252,0.35);
      transform: translateY(-2px);
    }

    .tier-btn.active {
      background: #71f8fc;
      color: #000;
    }

    #thanksToast {
      position: fixed;
      left: 50%;
      bottom: 14%;
      transform: translateX(-50%) scale(.9);
      background: rgba(0,0,0,0.7);
      color: #71f8fc;
      padding: 14px 26px;
      border-radius: 30px;
      opacity: 0;
      pointer-events: none;
      transition: .35s ease;
      box-shadow: 0 10px 40px rgba(113,248,252,0.4);
      z-index: 9999;
    }

    #thanksToast.show {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    .qrcode-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 30px;
      margin: 40px 0;
    }

    .qrcode {
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 18px 16px 22px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(113,248,252,0.15);
      transition: transform .25s ease, box-shadow .25s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .qrcode:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 12px 40px rgba(113,248,252,0.35);
    }

    .qrcode::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 20%, rgba(113,248,252,0.25), transparent 60%);
      opacity: 0;
      transition: .3s;
      pointer-events: none;
    }

    .qrcode:hover::after {
      opacity: 1;
    }

    .qrcode img {
      width: 180px;
      height: auto;
      border-radius: 12px;
      margin-bottom: 10px;
      transition: transform .25s ease;
    }

    .qrcode:hover img {
      transform: scale(1.05);
    }

    .qrcode p {
      margin: 8px 0 0;
      font-size: 15px;
      color: #71f8fc;
      letter-spacing: 1px;
    }

    .btn-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    button {
      background-color: #71f8fc;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      color: black;
      transition: 0.3s;
    }

    button:hover {
      background-color: #5ae0e6;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      color: #ccc;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .qrcode-section {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }
    .thanks-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .thanks-item {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(113,248,252,0.25);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 6px 18px rgba(113,248,252,0.15);
      animation: fadeInUp .4s ease both;
    }

    .thanks-item .name {
      color: #71f8fc;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .thanks-item .msg {
      color: #ddd;
      font-size: 13px;
      line-height: 1.4;
      opacity: .9;
    }

    .thanks-form {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(113,248,252,0.25);
      border-radius: 14px;
      padding: 14px;
    }

    .thanks-form input,
    .thanks-form textarea {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(113,248,252,0.4);
      border-radius: 10px;
      padding: 8px 10px;
      color: #fff;
      outline: none;
      font-size: 14px;
      resize: none;
    }

    .thanks-form input::placeholder,
    .thanks-form textarea::placeholder {
      color: #aaa;
    }

    .thanks-form button {
      align-self: center;
      padding: 8px 20px;
      border-radius: 20px;
      background: #71f8fc;
      border: none;
      cursor: pointer;
      transition: .25s;
    }

    .thanks-form button:hover {
      background: #5ae0e6;
    }

    #thanksTip {
      text-align: center;
      font-size: 12px;
      color: #aaa;
    }

    /* éª¨æ¶å±åŠ è½½æ•ˆæœ */
    .thanks-item.skeleton {
      height: 58px;
      background: linear-gradient(100deg,
        rgba(255,255,255,0.04) 40%,
        rgba(255,255,255,0.12) 50%,
        rgba(255,255,255,0.04) 60%);
      background-size: 200% 100%;
      animation: skeleton 1.2s ease infinite;
    }

    @keyframes skeleton {
      to { background-position: -200% 0; }
    }
    /* äºŒç»´ç æ”¾å¤§é¢„è§ˆ */
    .img-preview {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn .3s ease;
    }

    .img-preview.active {
      display: flex;
    }

    .img-preview img {
      max-width: 80vw;
      max-height: 80vh;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* åŠ è½½åŠ¨ç”»æ ·å¼ */
    #loading {
      position: fixed;
      z-index: 9999;
      background: #ffffff;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.6s ease;
    }

    .loader {
      border: 6px solid #e0faff;
      border-top: 6px solid #71f8fc;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    body.fade-in {
      animation: fadeBody 0.8s ease;
    }

    @keyframes fadeBody {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    body.fade-out {
      animation: fadeOut 0.6s ease forwards;
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- åŠ è½½åŠ¨ç”» -->
  <div id="loading">
    <div class="loader"></div>
  </div>

  <!-- äºŒç»´ç æ”¾å¤§é¢„è§ˆå±‚ -->
  <div id="imgPreview" class="img-preview">
    <img id="previewImg" src="" alt="é¢„è§ˆ">
  </div>

  <div id="thanksToast">æ„Ÿè°¢ä½ çš„æ”¯æŒï¼ğŸ’™</div>

  <div class="container">
    <h1>æ„Ÿè°¢ä½ çš„æ”¯æŒï¼</h1>
    <p id="userGreeting" style="text-align:center; margin-top:-10px; color:#bffcff;">
      æ¬¢è¿ä½ ï¼Œæœ‹å‹ ğŸ’™
    </p>
    <button id="logoutBtn" style="
      position:absolute;
      top:20px;
      right:20px;
      background: rgba(113,248,252,0.9);
      border: none;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      color: black;
      transition: 0.3s;
      z-index: 10;
    ">
      é€€å‡ºç™»å½•
    </button>
    <p style="text-align:center;">å¦‚æœä½ å–œæ¬¢æœ¬ç«™å†…å®¹ï¼Œå¯ä»¥é€‰æ‹©ä¸€ä¸ªæ–¹å¼æ”¯æŒæˆ‘ï¼š</p>

    <div class="tier-group">
      <button class="tier-btn" data-tier="coffee">â˜• è¯·ä½ å–æ¯å’–å•¡</button>
      <button class="tier-btn" data-tier="meal">ğŸ” è¯·ä½ åƒé¡¿é¥­</button>
      <button class="tier-btn" data-tier="biglove">ğŸ’– ç‹ ç‹ æ”¯æŒä¸€ä¸‹</button>
    </div>

    <p id="tierHint" style="text-align:center; margin-top:12px; color:#ccc; font-size:14px;">
      é€‰æ‹©æ¡£ä½åï¼Œæ‰«ç æ”¯ä»˜å³å¯ï½
    </p>
    
    <div class="qrcode-section">
      <div class="qrcode">
        <img src="p/wx.jpeg" alt="å¾®ä¿¡æ”¶æ¬¾ç " />
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
      <div class="qrcode">
        <img src="p/zfb.jpeg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç " />
        <p>æ”¯ä»˜å®</p>
      </div>
    </div>

    <h2 style="text-align:center; color:#71f8fc; margin-top:40px;">ğŸ’– ç²‰ä¸é¸£è°¢æ¦œ</h2>
    <p style="text-align:center; color:#ccc; font-size:14px; margin-bottom:14px;">
      æ„Ÿè°¢æ¯ä¸€ä½æ”¯æŒéœœè“çš„æœ‹å‹ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
    </p>

    <div id="thanksList" class="thanks-list">
      <div class="thanks-item skeleton"></div>
      <div class="thanks-item skeleton"></div>
      <div class="thanks-item skeleton"></div>
    </div>
    <div class="thanks-form">
      <input id="thanksName" type="text" placeholder="ä½ çš„æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰">
      <textarea id="thanksMsg" rows="3" placeholder="æƒ³å¯¹éœœè“è¯´çš„è¯ï¼ˆå¯é€‰ï¼‰"></textarea>
      <button id="submitThanks">æäº¤åˆ°é¸£è°¢æ¦œ</button>
      <p id="thanksTip">æäº¤åä¼šæ˜¾ç¤ºåœ¨æ¦œå•ä¸­ ğŸ’™</p>
    </div>

    <div class="btn-group">
      <button id="backBtn">è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="footer">
      CopyrightÂ©ï¸2024-2026 éœœè“, All Rights Reserved.
    </div>
  </div>

  <!-- è·³è½¬ä¸åŠ è½½é€»è¾‘ -->
  <script>
    window.addEventListener('load', () => {
      document.body.classList.add('fade-in');
      const loader = document.getElementById('loading');
      if (loader) {
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 600);
      }
    });

    // æ‰€æœ‰ a[href] å’ŒæŒ‰é’®è·³è½¬æ·»åŠ æ·¡å‡ºåŠ¨ç”»
    document.addEventListener("DOMContentLoaded", () => {
      // é“¾æ¥è·³è½¬å¤„ç†
      const links = document.querySelectorAll("a[href]");
      links.forEach(link => {
        const href = link.getAttribute("href");
        if (!href.startsWith("#") && !href.startsWith("javascript")) {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            document.body.classList.add("fade-out");
            setTimeout(() => window.location.href = href, 600);
          });
        }
      });

      // æŒ‰é’®è·³è½¬å¤„ç†
      const backBtn = document.getElementById("backBtn");
      if (backBtn) {
        backBtn.addEventListener("click", () => {
          document.body.classList.add("fade-out");
          setTimeout(() => window.location.href = "index.html", 600);
        });
      }
    });

    // ç‚¹å‡»äºŒç»´ç æ”¾å¤§é¢„è§ˆ
    const preview = document.getElementById("imgPreview");
    const previewImg = document.getElementById("previewImg");

    document.querySelectorAll(".qrcode img").forEach(img => {
      img.addEventListener("click", () => {
        previewImg.src = img.src;
        preview.classList.add("active");
      });
    });

    preview.addEventListener("click", () => {
      preview.classList.remove("active");
    });
  </script>
  <script type="module">
    import { supabase } from './p/js/supabaseClient.js';

    // åŠ è½½ç²‰ä¸é¸£è°¢æ¦œ
    const thanksList = document.getElementById("thanksList");

    async function loadThanks() {
      const { data, error } = await supabase
        .from("thanks")
        .select("name, message, created_at")
        .order("created_at", { ascending: false })
        .limit(12);

      if (error || !data) {
        if (thanksList) {
          thanksList.innerHTML = '<div class="thanks-item"><div class="msg">æš‚æ— é¸£è°¢è®°å½•ï¼ŒæœŸå¾…ä½ çš„ç¬¬ä¸€ä»½æ”¯æŒ ğŸ’™</div></div>';
        }
        return;
      }

      if (thanksList) {
        thanksList.innerHTML = data.map(item => `
          <div class="thanks-item">
            <div class="name">${item.name || "åŒ¿åæœ‹å‹"}</div>
            <div class="msg">${item.message || "æ„Ÿè°¢æ”¯æŒï¼"}</div>
          </div>
        `).join("");
      }
    }

    loadThanks();

    // æ˜¾ç¤ºç”¨æˆ·æ˜µç§°/é‚®ç®±
    const { data: { user } } = await supabase.auth.getUser();
    const greet = document.getElementById("userGreeting");
    if (user && greet) {
      greet.textContent = `æ¬¢è¿ä½ ï¼Œ${user.user_metadata?.name || user.email || "æœ‹å‹"} ğŸ’™`;
    }

    // é€€å‡ºç™»å½•ï¼ˆå¼ºåˆ¶å¯ç”¨ç‰ˆï¼‰
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();

        try {
          await supabase.auth.signOut();
          console.log("Signed out");
        } catch (err) {
          console.warn("Sign out failed, redirect anyway:", err);
        }

        document.body.classList.add("fade-out");
        setTimeout(() => window.location.href = "index.html", 600);
      });
    }

    // æäº¤é¸£è°¢ç•™è¨€
    const submitBtn = document.getElementById("submitThanks");
    const nameInput = document.getElementById("thanksName");
    const msgInput = document.getElementById("thanksMsg");
    const tip = document.getElementById("thanksTip");

    if (submitBtn) {
      submitBtn.addEventListener("click", async () => {
        submitBtn.disabled = true;
        submitBtn.textContent = "æäº¤ä¸­...";

        const { data: { user } } = await supabase.auth.getUser();

        const name =
          nameInput.value.trim() ||
          user?.user_metadata?.name ||
          user?.email ||
          "åŒ¿åæœ‹å‹";

        const message = msgInput.value.trim() || "æ„Ÿè°¢æ”¯æŒï¼";

        const { error } = await supabase.from("thanks").insert({
          name,
          message
        });

        if (error) {
          console.error(error);
          tip.textContent = "æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•";
          submitBtn.disabled = false;
          submitBtn.textContent = "æäº¤åˆ°é¸£è°¢æ¦œ";
          return;
        }

        nameInput.value = "";
        msgInput.value = "";
        tip.textContent = "å·²æäº¤ï¼Œæ„Ÿè°¢ä½ çš„æ”¯æŒï¼ğŸ’™";

        await loadThanks();

        submitBtn.disabled = false;
        submitBtn.textContent = "æäº¤åˆ°é¸£è°¢æ¦œ";
      });
    }

    // æ¡£ä½é€‰æ‹©æ•ˆæœ
    const tierBtns = document.querySelectorAll(".tier-btn");
    const hint = document.getElementById("tierHint");
    let selectedTier = null;

    tierBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        tierBtns.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedTier = btn.dataset.tier;

        if (selectedTier === "coffee") hint.textContent = "â˜• å·²é€‰æ‹©ï¼šå’–å•¡æ¡£ä½ï¼Œæ„Ÿè°¢ä½ çš„æ¸©æŸ”æ”¯æŒï½";
        if (selectedTier === "meal") hint.textContent = "ğŸ” å·²é€‰æ‹©ï¼šåƒé¥­æ¡£ä½ï¼Œä»Šå¤©åŠ ä¸ªé¸¡è…¿ï¼";
        if (selectedTier === "biglove") hint.textContent = "ğŸ’– å·²é€‰æ‹©ï¼šç‹ ç‹ çˆ±æˆ‘æ¡£ä½ï¼ŒçœŸçš„å¤ªæ„ŸåŠ¨äº†ï¼";
      });
    });

    // æ‰«ç ç‚¹å‡»æ„Ÿè°¢åŠ¨ç”»
    const toast = document.getElementById("thanksToast");
    document.querySelectorAll(".qrcode img").forEach(img => {
      img.addEventListener("click", () => {
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 1800);
      });
    });
  </script>
</body>
</html>