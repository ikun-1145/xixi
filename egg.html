<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hidden Layer · 霜蓝协议</title>

<style>
:root{
  --accent:#71f8fc;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body{
  min-height:100dvh;
  background:
    linear-gradient(135deg, #dcefff, #f8fdff),
    url('p/bj.png') center / cover no-repeat fixed;
  color:var(--accent);
  font-family: "Courier New", "Consolas", "Lucida Console", monospace;
  overflow:auto;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  transition: background 2.5s ease;
  user-select:text;
  -webkit-user-select:text;
}

/* 扫描线 */
body::after{
  content:"";
  position:fixed;
  inset:0;
  background:repeating-linear-gradient(
    0deg,
    rgba(113,248,252,0.05) 0px,
    rgba(113,248,252,0.05) 2px,
    transparent 2px,
    transparent 6px
  );
  pointer-events:none;
  animation:scanMove 8s linear infinite;
}

body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size:3px 3px;
  opacity:0;
  transition:opacity 1s ease;
}

body.dark-mode::before{
  opacity:0.4;
}

@keyframes scanMove{
  from{ background-position:0 0; }
  to{ background-position:0 100px; }
}

@keyframes backgroundShift {
  0% {
    background:
      linear-gradient(135deg, #dcefff, #f8fdff),
      url('p/bj.png') center / cover no-repeat fixed;
  }
  40% {
    background:
      linear-gradient(135deg, #c8e8ff, #e8faff),
      url('p/bj.png') center / cover no-repeat fixed;
  }
  100% {
    background:
      radial-gradient(circle at 50% 40%, rgba(113,248,252,0.08), transparent 60%),
      #05070d;
  }
}


body.dark-mode{
  animation: backgroundShift 3.5s ease forwards;
}

/* 如果检测到夜间模式，直接进入黑背景 */
body.instant-dark{
  background:
    radial-gradient(circle at 50% 40%, rgba(113,248,252,0.08), transparent 60%),
    #05070d;
}


.container{
  text-align:left;
  width:min(700px,90%);
  line-height:1.7;
  font-size:15px;
  opacity:0;
  animation:fadeIn 2s ease forwards 3.8s;
}

@keyframes fadeIn{
  to{ opacity:1; }
}

h1{
  font-size:22px;
  margin-bottom:1.2rem;
  letter-spacing:1px;
}

.typing{
  border-right:2px solid var(--accent);
  white-space:nowrap;
  overflow:hidden;
  width:0;
  animation:typing 4s steps(60,end) forwards 4.2s,
           blink 1s step-end infinite 8.2s;
}

@keyframes typing{
  to{ width:100%; }
}

@keyframes blink{
  50%{ border-color:transparent; }
}

.log{
  margin-top:1.5rem;
  opacity:0;
  animation:fadeIn 2s ease forwards 8.5s;
}

.return-btn{
  margin-top:2rem;
  display:inline-block;
  padding:10px 18px;
  border:1px solid var(--accent);
  color:var(--accent);
  text-decoration:none;
  opacity:0;
  transition:all .3s ease;
  animation:fadeIn 2s ease forwards 13s;
}

.return-btn:hover{
  background:var(--accent);
  color:#000;
  box-shadow:0 0 20px var(--accent);
}

/* 背景缓慢旋转 */
@keyframes slowRotate{
  from{ transform:rotate(0deg); }
  to{ transform:rotate(360deg); }
}

 


.cursor-char{
  background:var(--accent);
  color:#000;
  animation:cursorBlink 1s steps(1) infinite;
}

.cursor-block{
  display:inline-block;
  width:0.6ch;
  height:1.2em;
  background:var(--accent);
  transform:translateY(2px);
  animation:cursorBlink 1s steps(1) infinite;
}

@keyframes cursorBlink{
  0%{ opacity:1; }
  50%{ opacity:0; }
  100%{ opacity:1; }
}

#currentLine{
  display:flex;
  align-items:flex-end;
  margin-top:2px;
}

/* 新增 console 字体样式 */
#console{
  font-family:"Courier New", "SF Mono", monospace;
  letter-spacing:0.5px;
}


#terminal{
  max-height:60vh;
  height:60vh;
  overflow-y:auto;
  padding-right:6px;
  border:1px solid rgba(113,248,252,0.25);
  padding:12px;
  background:rgba(0,0,0,0.25);
}

#terminal p{
  margin:2px 0;
  line-height:1.4;
}

/* 新增隐藏输入框样式 */
#hiddenInput{
  position:absolute;
  opacity:0;
  pointer-events:none;
  height:0;
}

@media (max-width:768px){
  #console{
    font-size:13px;
  }
  .prompt{
    font-size:13px;
  }
  #terminal{
    max-height:320px;
    height:320px;
  }
}

.bg-orb{
  position:absolute;
  width:900px;
  height:900px;
  border-radius:50%;
  background:radial-gradient(circle,
    rgba(113,248,252,0.08),
    transparent 60%
  );
  animation:slowRotate 60s linear infinite;
  z-index:-1;
  transition: filter .3s ease;
}


.particles{
  position:fixed;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index:-1;
}

.particles span{
  position:absolute;
  width:2px;
  height:2px;
  background:rgba(113,248,252,0.6);
  border-radius:50%;
  animation:particleFloat linear infinite;
}

@keyframes particleFloat{
  from{ transform:translateY(100vh) scale(0.8); opacity:0; }
  10%{ opacity:1; }
  90%{ opacity:1; }
  to{ transform:translateY(-10vh) scale(1.2); opacity:0; }
}


/* 黑幕层样式 */
#blackout{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity 1s ease;
  z-index:9999;
}

#blackout.active{
  opacity:1;
  pointer-events:auto;
}

body.entering-deep #console{
  filter:brightness(0.4) contrast(0.8);
  transform:scale(1.03);
  transition:all 1.2s ease;
}

#accessFlash{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
  letter-spacing:4px;
  color:#71f8fc;
  opacity:0;
  pointer-events:none;
  z-index:10000;
  transition:opacity .6s ease;
}

#accessFlash.active{
  opacity:1;
}

  </style>
  <!-- ===== 新终端内核 ===== -->
  <script src="p/js/terminal-core.js"></script>
</head>

<body>

<div class="bg-orb"></div>
<div class="particles" id="particles"></div>
<div id="blackout"></div>
<div id="accessFlash">ACCESS GRANTED</div>

<div class="container">
  <h1>霜蓝协议 · Hidden Layer</h1>

  <div class="typing">
    SYSTEM BREACH DETECTED · ACCESSING CORE MEMORY...
  </div>

  <div class="log" id="logArea">
    <p>> 你已穿过主界面。</p>
    <p>> 这里不是展示区。</p>
    <p>> 这里是正在思考的部分。</p>
    <p>> 项目状态：进行中</p>
    <p>> 当前维度：未公开层</p>
    <br>
    <p>有些东西不会出现在首页。</p>
    <p>但它们一直在运行。</p>
  
  <div id="console" style="margin-top:2rem; opacity:0; animation:fadeIn 2s ease forwards 10s; font-size:14px;">
  <div id="terminal">
    <div id="currentLine">
      <span class="prompt" id="promptText">霜蓝@hidden-layer:~$ </span>
      <span id="consoleInput"></span>
    </div>
  </div>
  <input id="hiddenInput" type="text" autocomplete="off"
         style="position:fixed;bottom:0;left:0;opacity:0;height:1px;width:1px;" />
</div>
  </div>

  <a href="index.html" class="return-btn">返回现实</a>
</div>

<script>
window.addEventListener("load", () => {
  // ===== 背景模式控制 =====
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  if (prefersDark) {
    document.body.classList.add("instant-dark");
  } else {
    setTimeout(() => {
      document.body.classList.add("dark-mode");
    }, 100);
  }
  // ===== 基础校验 =====
  if (!sessionStorage.getItem("eggAccess")) {
    window.location.href = "index.html";
    return;
  }
  sessionStorage.removeItem("eggAccess");

  // ===== 新终端引擎初始化 =====
  const term = createTerminal({
    user: "sunland",
    isRoot: false,
    startPath: "~"
  });
  const { registerCommand, printLine, state, handlers, resolvePath, fs, updatePrompt, renderInput, execute } = term;

  /* ===== echo 命令（支持简单 $(cmd)）===== */
  handlers.echo = function(args){
    let text = args.join(" ");

    // 简单 $(...) 解析（不支持嵌套）
    const subMatch = text.match(/\$\(([^)]+)\)/);
    if(subMatch){
      const subCmd = subMatch[1].trim().split(" ");
      const originalPrint = printLine;
      let captured = "";

      // 临时劫持输出
      printLine = function(t){ captured += t; };
      execute(subCmd);
      printLine = originalPrint;

      text = text.replace(subMatch[0], captured);
    }

    printLine(text);
  };

  /* ===== ps 命令（假进程表）===== */
  handlers.ps = function(){
    printLine("  PID TTY          TIME CMD");
    printLine("    1 tty1     00:00:00 systemd");
    printLine("   42 tty1     00:00:00 snapd");
    printLine("  101 tty1     00:00:00 bash");
    printLine("  202 tty1     00:00:00 hidden-layer");
  };

  /* ===== top 命令（实时刷新，可 Ctrl+C 退出）===== */
  handlers.top = function(){
    if(state.running) return;
    state.running = true;

    function renderTop(){
      if(!state.running) return;
      handlers.clear();
      printLine("top - hidden-layer simulation");
      printLine("Tasks: 4 total, 1 running");
      printLine("CPU: " + Math.floor(Math.random()*40+10) + "%");
      printLine("MEM: " + Math.floor(Math.random()*60+20) + "%");
      printLine("");
      printLine("  PID  COMMAND");
      printLine("    1  systemd");
      printLine("   42  snapd");
      printLine("  101  bash");
      printLine("  202  hidden-layer");
      setTimeout(renderTop,1000);
    }

    renderTop();
  };

  registerCommand("secret", ()=>{
    if(!state.isRoot || state.path !== "/root"){
      printLine("Access denied.");
      return;
    }
    printLine("Access token validated.");
    document.getElementById("accessFlash").classList.add("active");
    setTimeout(()=>{
      document.getElementById("blackout").classList.add("active");
    },600);
    setTimeout(()=>{
      window.location.href="deep.html";
    },1600);
  });

  registerCommand("crythane", ()=>{
    printLine("Opening external layer...");
    document.getElementById("accessFlash").classList.add("active");
    setTimeout(()=>{
      document.getElementById("blackout").classList.add("active");
    },400);
    setTimeout(()=>{
      window.location.href="https://crythane.pages.dev/";
    },1200);
  });


  // ===== 稳定聚焦锁定（防止移动端失焦） =====
  const hiddenInputEl = document.getElementById("hiddenInput");

  function lockFocus(){
    if(document.activeElement !== hiddenInputEl){
      hiddenInputEl.focus();
    }
  }

  // 初始化聚焦
  lockFocus();

  // 点击任意位置都重新聚焦
  document.addEventListener("click", lockFocus);

  // 触屏设备支持
  document.addEventListener("touchstart", ()=>{
    hiddenInputEl.focus();
  }, { passive:true });

  // 页面重新可见时聚焦
  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden){
      lockFocus();
    }
  });

  // 定期校正焦点（防止动画抢焦点）
  setInterval(lockFocus, 1500);

  // 修改 handlers.help 输出
  handlers.help = function(){
    printLine("Built-in commands: help ls cd pwd whoami history clear cat sudo alias echo ps top sleep jobs fg kill export exit");
  };
});
</script>

<style>
.matrix-mode{
  background:#000 !important;
  color:#00ff66 !important;
}

.matrix-mode #terminal{
  background:#000 !important;
  border-color:#00ff66;
}
</style>

</body>
</html>